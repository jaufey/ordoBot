# 🧠 Life Scheduler · 生活全能安排助手

> 一款专为 **缺乏行动力、焦虑、需要确定感** 的人群设计的任务/计划系统。
>
> **核心价值**：它不只是一个待办事项列表，而是一个**全生命周期生活管家**。通过 AI 帮你拆分任务、倒推时间、合并行程、提醒执行和温柔鼓励，旨在帮助用户恢复对生活的**掌控感**。

---

## ✨ 核心愿景与设计哲学

我们希望用户能够**“交出大脑”**，让系统帮助安排好一整天，从而减轻认知负担和行动焦虑。

| 核心哲学 | 描述 | 目标体验 |
| :--- | :--- | :--- |
| **给用户确定感** | 提供**“满满当当”**的计划，而非空泛的任务列表（满足需要安全感的人）。 | 用户感到“你只要照做就好”，获得行动的安全感。 |
| **温情驱动** | 避免冷冰冰的报错或责备。 | **允许失败**，系统用温柔话术鼓励用户重新开始（“没关系，生活总有意外…”）。 |
| **提前化解混乱** | 实时检测并**自动重排**冲突任务。 | 用户看到**“被安排好”**的生活，生活不慌乱。 |
| **多轮澄清** | 模糊输入时，AI 会**追问**确认细节（如出门时间）。 | 减少后续失误，让用户觉得“系统很细心”。 |
| **可控的主动性** | AI 的主动干预（如建议早睡）是**可调节**的（基于用户信任等级）。 | 允许系统主动，但必须温柔、可解释、可拒绝。 |

---

## 🚀 核心功能概述 (Functionality)

### 1. 📝 任务解析与入库

系统通过 **自然语言** 处理用户输入，并支持多轮澄清，将信息精确入库。

| 功能点 | 细节描述 | 示例 |
| :--- | :--- | :--- |
| **自然语言解析** | 提取 `title`、`startTime`、`priority`、`contextConstraints` 等关键字段。 | “十分钟后提醒我关掉煮蛋器” |
| **意图识别 (Intent)** | 支持 **5 种意图**：`add_task`、`mark_done`、`query_tasks`、`cancel_task`、`smalltalk`，对应不同的数据库处理逻辑。 | — |
| **多轮追问支持** | 模糊输入时，AI 返回 `clarificationQuestions` 逐条询问，补全信息，**不直接入库**。 | 用户说“去机场”，系统追问“是航班起飞时间还是出门时间？” |

### 2. ⏱ 智能调度与冲突管理

系统利用 `estimatedDuration` 和时间扫描，实现高级自动调度。

* **倒推与预留**：支持 `estimatedDuration` 字段，自动计算任务开始时间，并可多轮追问推导**准备时间**（如收拾行李开始时间）。
* **🔀 冲突检测与重排**：**每 5 分钟**扫描未来两小时任务，检测时间、地点冲突。AI 给出 `explanation` 和建议，用户可通过 inline keyboard 采纳/忽略。
* **🧩 任务合并 (Combine)**：**每 15 分钟**扫描未来四小时任务。AI 识别相同/相近地点或顺路任务，建议合并执行。

### 3. ⏳ 条件任务、提醒与恢复机制

* **条件任务**：支持 `conditionConstraints`，如：`{"weather": "not_rainy"}`。系统在提醒前检查条件，若不满足则自动**顺延任务**。
* **🔔 到点提醒**：每分钟扫描即将到期任务，推送提醒（附带 explanation），并提供操作按钮：**完成 ✅、推迟 ⏰、取消 🗑**，防止重复提醒（使用 `notified` 字段）。
* **⏰ 过期重排**：**每 10 分钟**扫描已过期未完成任务，调用 AI **自动重排**，推送新时间 + 鼓励语（温情恢复）。

### 4. 👤 用户画像与偏好

`users` 表存储用户数据，用于未来更精准的调度：

* 时区、提醒偏好、鼓励语气风格。
* 健康/饮食偏好（乳糖不耐、低糖饮食等）。
* **信任等级**（决定系统主动性）。

---

## 🤖 AI 责任边界与策略

我们的策略是：**大胆用 AI，但保持可控和可解释**。

| AI 角色（“脑子”） | 程序角色（“手脚”） |
| :--- | :--- |
| **理解、推理、建议**：意图解析、追问生成、冲突解释、任务合并建议、重排方案、鼓励话术。 | **计算、保证、执行**：时间计算、依赖管理、提醒调度、数据库写入，保证稳定可预测。 |
| **核心原则**：AI 结果永远带 **`explanation`**，确保用户理解**“为什么”**。 | **核心原则**：核心调度不交给 AI，保证系统不会因模型波动而漏提醒。 |

---

## 🛠️ 技术实现细节

### 🏗 数据库设计 (Drizzle Schema)

| 表名 | 作用 |
| :--- | :--- |
| `users` | 用户信息、时区、偏好、主动性 |
| `tasks` | 主任务表，含 `rawInput`、`intent`、`constraints`、`done`、`notified`、`snoozedUntil` |
| `clarifications` | 多轮追问队列表，顺序执行、落库回答 |
| `combos` & `comboItems` | 任务合并建议和落地结果 |

### 📦 模块结构
src/
├─ ai/          # AI Function Calls (parseTask, detectConflicts, suggestCombos, replanTasks)
├─ core/        # 核心逻辑 (scheduler, notifier, conflictHandler, comboHandler, clarificationFlow)
├─ db/          # drizzle schema + 初始化
├─ bot/         # grammY (Telegram) 入口 & 交互
├─ cron/        # 定时扫描入口 (定时调度逻辑)
└─ utils/       # 工具函数 (OpenAI client, 时间解析)


### 🔧 开发 & 运行

```bash
npm install
cp .env.example .env
# 填写 OPENAI_API_KEY / BOT_TOKEN / DATABASE_URL

npx drizzle-kit push      # 初始化数据库
npx tsx src/bot/index.ts  # 启动 Telegram bot
npx tsx src/cron/index.ts # 启动定时任务（核心调度逻辑）